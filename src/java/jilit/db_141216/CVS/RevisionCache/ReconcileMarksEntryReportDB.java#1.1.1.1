/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package jilit.db;

import java.io.File;
import java.io.FileInputStream;
import java.sql.ResultSet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.xssf.usermodel.XSSFSheet;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import tietwebkiosk.DBHandler;
import tietwebkiosk.GlobalFunctions;
import tietwebkiosk.OLTEncryption;

/**
 *
 * @author nipun.gupta
 */
public class ReconcileMarksEntryReportDB {
    

    public void selectSaveUpdateData(HttpServletRequest req, HttpServletResponse res){
        try {
            //******************READ FROM JSP**********************************************************************************
             GlobalFunctions gb = new GlobalFunctions();
            OLTEncryption enc = new OLTEncryption();
            DBHandler db = new DBHandler();
            ResultSet rs = null, rssub = null, rsm = null, rs1 = null;
            String mMemberID = "", mMemberType = "", mDMemberType = "", mMemberName = "", mMemberCode = "", mInst = "", mDMemberCode = "", mCheckFstid = "", mSMarks = "";
            String mComp = "", mSelf = "", mIC = "", mEC = "", mSC = "", mList = "", mOrder = "", mEvent = "", mSE = "", qry = "", qry1 = "", qry2 = "", mMOP = "",jspMarks="",excelMarks="";
            int len = 0, pos = 0, ctr = 0,counter=1;
            double mWeight = 0, mMaxmarks = 0;
            if (req.getSession().getAttribute("MemberID") == null) {
                mMemberID = "";
            } else {
                mMemberID = req.getSession().getAttribute("MemberID").toString().trim();
            }

            if (req.getSession().getAttribute("MemberType") == null) {
                mMemberType = "";
            } else {
                mMemberType = req.getSession().getAttribute("MemberType").toString().trim();
            }

            if (req.getSession().getAttribute("MemberName") == null) {
                mMemberName = "";
            } else {
                mMemberName = req.getSession().getAttribute("MemberName").toString().trim();
            }

            if (req.getSession().getAttribute("MemberCode") == null) {
                mMemberCode = "";
            } else {
                mMemberCode = req.getSession().getAttribute("MemberCode").toString().trim();
            }

            if (req.getSession().getAttribute("InstituteCode") == null) {
                mInst = "";
            } else {
                mInst = req.getSession().getAttribute("InstituteCode").toString().trim();
            }

            if (req.getSession().getAttribute("CompanyCode") == null) {
                mComp = "";
            } else {
                mComp = req.getSession().getAttribute("CompanyCode").toString().trim();
            }

            if (req.getSession().getAttribute("Click") != null) {
                mSelf = req.getSession().getAttribute("Click").toString().trim();
            } else {
                mSelf = "";
            }
            if (req.getSession().getAttribute("InstCode") != null) {
                mIC = req.getSession().getAttribute("InstCode").toString().trim();
            } else {
                mIC = "";
            }
            if (req.getSession().getAttribute("Exam") != null) {
                mEC = req.getSession().getAttribute("Exam").toString().trim();
            } else {
                mEC = "";
            }
            if (req.getSession().getAttribute("Subject") != null) {
                mSC = req.getSession().getAttribute("Subject").toString().trim();
            } else {
                mSC = "";
            }
            if (req.getSession().getAttribute("listorder") != null) {
                mList = req.getSession().getAttribute("listorder").toString().trim();
            } else {
                mList = "EnrollNo";
            }
            if (req.getSession().getAttribute("order") != null) {
                mOrder = req.getSession().getAttribute("order").toString().trim();
            } else {
                mOrder = "";
            }
            if (req.getSession().getAttribute("Event") != null) {
                mEvent = req.getSession().getAttribute("Event").toString().trim();
            } else {
                mEvent = "";
            }
            len = mEvent.length();
            pos = mEvent.indexOf("#");
            if (pos > 0) {
                mSE = mEvent.substring(0, pos);
            } else {
                mSE = mEvent.toString().trim();
            }
            
            
             if (!mMemberID.equals("") && !mMemberCode.equals("") && !mMemberName.equals("")) {
                mDMemberCode = enc.decode(mMemberCode);
                mDMemberType = enc.decode(mMemberType);
                String mCode = enc.decode(mMemberCode);
                String mChkMemID = enc.decode(req.getSession().getAttribute("MemberID").toString().trim());
                String mChkMType = enc.decode(req.getSession().getAttribute("MemberType").toString().trim());
                String mIPAddress = req.getSession().getAttribute("IPADD").toString().trim();
                String mRole = enc.decode(req.getSession().getAttribute("ROLENAME").toString().trim());
                ResultSet RsChk = null;
                //-----------------------------
                //-- Enable Security Page Level  
                //-----------------------------
                qry = "Select WEBKIOSK.ShowLink('60','" + mChkMemID + "','" + mChkMType + "','" + mRole + "','" + mIPAddress + "') SL from dual";
                RsChk = db.getRowset(qry);
                if (RsChk.next() && RsChk.getString("SL").equals("Y")) {

                    String mSubcode = "", qrysub = "", mNam = "";
                    qrysub = "select subject,subjectcode from subjectmaster where InstituteCode='" + mIC + "' and subjectID='" + mSC + "' and nvl(deactive,'N')='N' ";
                    //System.out.println(qrysub);
                    rssub = db.getRowset(qrysub);
                    if (rssub.next()) {
                        mNam = rssub.getString("subject");
                        mSubcode = rssub.getString("subjectcode");
                    } else {
                        mNam = "";
                        mSubcode = "";
                    }
                    String name = "", time = "";
                    String query123 = "select employeename,to_char(sysdate,'DD/MM/YYYY HH:MI:SS AM')dd from employeemaster where employeeid='" + mChkMemID + "'";
                    //out.println(query123);
                    rssub = db.getRowset(query123);
                    if (rssub.next()) {
                        name = rssub.getString("employeename");
                        time = rssub.getString("dd");
                    }
                    if (mSelf.equals("Self")) {
                        qry = "select fstid,nvl(studentid,' ')studentid,nvl(studentname,' ')StudentName, nvl(enrollmentno,' ')EnrollNo, nvl(semester,0)Semester,";
                        qry = qry + " nvl(programcode,' ')||' ('||nvl(SECTIONBRANCH,' ')||' - '||subsectioncode||')' Course from V#EXAMEVENTSUBJECTTAGGING ";
                        qry = qry + " where institutecode='" + mIC + "' and nvl(DEACTIVE,'N')='N' and nvl(PROCEEDSECOND,'N')='N' and nvl(locked,'N')='N' and nvl(PUBLISHED,'N')='N' and ";
                        qry = qry + " examcode='" + mEC + "' and (ltp='L' OR (LTP='E' AND PROJECTSUBJECT='Y') OR LTP='P' ) and subjectID='" + mSC + "' ";
                        //qry=qry+" AND employeeid='"+mChkMemID+"' and facultytype=decode('"+mDMemberType+"','E','I','E')";
                        qry = qry + " AND ((EMPLOYEEID=(Select '" + mChkMemID + "' EmployeeID from dual)) OR (fstid in (select fstid from FACULTYSUBJECTTAGGING where companycode='" + mComp + "' and institutecode='" + mIC + "' and facultytype=decode('" + mDMemberType + "','E','I','E') and employeeid='" + mChkMemID + "')) and facultytype=decode('" + mDMemberType + "','E','I','E'))";
                        //qry=qry+" AND employeeid in (Select '"+mChkMemID+"' EmployeeID from dual UNION Select EmployeeID from FacultySubjectTagging where FSTID in (SELECT FSTID FROM MULTIFACULTYSUBJECTTAGGING WHERE COMPANYCODE='"+mComp+"' and INSTITUTECODE='"+mIC+"' and FACULTYTYPE=decode('"+mDMemberType+"','E','I','E') and EMPLOYEEID='"+mChkMemID+"')) and facultytype=decode('"+mDMemberType+"','E','I','E')";
                        qry = qry + " AND EVENTSUBEVENT='" + mEvent + "' ";
                        qry = qry + "  AND ( (studentid, fstid) IN (SELECT studentid, fstid FROM StudentEventSubjectMarks WHERE EVENTSUBEVENT = '"+mEvent+"'";
                        qry = qry + " AND NVL (DEACTIVE, 'N') = 'N' AND NVL (locked, 'N') = 'N') OR (studentid, fstid) NOT IN (SELECT studentid, fstid ";
                        qry = qry + " FROM StudentEventSubjectMarks WHERE EVENTSUBEVENT = '"+mEvent+"' AND NVL (DEACTIVE, 'N') = 'N' ";
                        qry = qry + " AND NVL (locked, 'N') = 'Y')) AND STUDENTID NOT IN (SELECT DISTINCT studentid FROM debarstudentdetail WHERE NVL (REEXAMINATION, 'N') = 'Y') ";
                        qry = qry + " GROUP BY fstid,studentid,StudentName,enrollmentno,Semester, programcode,SECTIONBRANCH, subsectioncode";
                        qry = qry + " order by " + mList + " " + mOrder + " ";

                        qry1 = "select WEIGHTAGE, MARKSORPERCENTAGE, MAXMARKS from V#EXAMEVENTSUBJECTTAGGING  ";
                        qry1 += " where institutecode='" + mIC + "' and  examcode='" + mEC + "' ";
                        qry1 += " AND ((EMPLOYEEID=(Select '" + mChkMemID + "' EmployeeID from dual)) OR (fstid in (select fstid from FACULTYSUBJECTTAGGING where companycode='" + mComp + "' and institutecode='" + mInst + "' and facultytype=decode('" + mDMemberType + "','E','I','E') and employeeid='" + mChkMemID + "')) and facultytype=decode('" + mDMemberType + "','E','I','E'))";
                        qry1 += " And EVENTSUBEVENT='" + mEvent + "' and (ltp='L' OR (LTP='E' AND PROJECTSUBJECT='Y') OR LTP='P') and subjectID='" + mSC + "' AND  NVL (deactive, 'N') = 'N' ";

                    } else if (!mSelf.equals("Self")) {
                        qry = "select fstid,nvl(studentid,' ')studentid,nvl(studentname,' ')StudentName, nvl(enrollmentno,' ')EnrollNo, nvl(semester,0)Semester,";
                        qry = qry + " nvl(programcode,' ')||' ('||nvl(SECTIONBRANCH,' ')||' - '||subsectioncode||')' Course from V#EXAMEVENTSUBJECTTAGGING ";
                        qry = qry + " where institutecode='" + mIC + "' and nvl(DEACTIVE,'N')='N' and nvl(PROCEEDSECOND,'N')='N' and nvl(locked,'N')='N' and nvl(PUBLISHED,'N')='N' and ";
                        qry = qry + " examcode='" + mEC + "'  and (ltp='L' OR (LTP='E' AND PROJECTSUBJECT='Y') OR LTP='P' ) and subjectID='" + mSC + "' ";
                        qry = qry + " And EVENTSUBEVENT='" + mEvent + "' ";
                        qry = qry + " AND FSTID IN (SELECT FSTID FROM EX#SUBJECTGRADECOORDINATOR WHERE COMPANYCODE='" + mComp + "' and INSTITUTECODE='" + mIC + "' and FACULTYTYPE=decode('" + mDMemberType + "','E','I','E') and FACULTYID='" + mChkMemID + "')";
                        qry = qry + " GROUP BY fstid,studentid,StudentName,enrollmentno,Semester, programcode,SECTIONBRANCH, subsectioncode";
                        qry = qry + " order by " + mList + " " + mOrder + " ";

                        qry1 = "select  WEIGHTAGE, MARKSORPERCENTAGE, MAXMARKS from V#EXAMEVENTSUBJECTTAGGING  ";
                        qry1 += " where institutecode='" + mIC + "' and  examcode='" + mEC + "' ";
                        qry1 += " And EVENTSUBEVENT='" + mEvent + "'  ";
                        qry1 += " and (ltp='L' OR (LTP='E' AND PROJECTSUBJECT='Y') OR LTP='P') and subjectID='" + mSC + "' AND  NVL (deactive, 'N') = 'N'";
                    }
                    //System.out.println(qry);
                    rsm = db.getRowset(qry1);
                    if (rsm.next()) {
                        mMOP = rsm.getString("MARKSORPERCENTAGE");
                        mMaxmarks = rsm.getDouble("MAXMARKS");
                        mWeight = rsm.getDouble("WEIGHTAGE");
                    }

                    rs = db.getRowset(qry);

                    while (rs.next()) {





                        
                        if (ctr == 0) {
                            
                        }
                        qry2 = "Select fstid,studentid,nvl(MARKSAWARDED1,-1)MARKSAWARDED1, ";
                        qry2 = qry2 + " nvl(DETAINED,'N') DETAINED from V#STUDENTEVENTSUBJECTMARKS ";
                        qry2 = qry2 + " where INSTITUTECODE='" + mIC + "' and EXAMCODE='" + mEC + "' and ";
                        qry2 = qry2 + " EVENTSUBEVENT='" + mEvent + "' and   ";
                        qry2 = qry2 + " fstid='" + rs.getString("fstid") + "' and STUDENTID='" + rs.getString("studentid") + "' ";
                        //  	System.out.print("JILIT - "+qry);
                        rs1 = db.getRowset(qry2);
                        if (rs1.next()) {
                            mSMarks = rs1.getString("MARKSAWARDED1");

                        }
                         jspMarks=jspMarks+mSMarks+",";
                        
                        ctr++;
                        counter++;
                    }
                    

                }
            }
             System.out.println(">>>>>>>>>>>>>>>>jspMarks>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>"+jspMarks);
            //****************************READ FROM EXCEL*******************************************************************************
             try {

            FileInputStream file = new FileInputStream(new File("D://UPLOAD//MarksEntryTempPage.xlsx"));
            XSSFWorkbook workbook = new XSSFWorkbook(file);

            //Get first/desired sheet from the workbook
            XSSFSheet sheet = workbook.getSheetAt(0);

            //Iterate through each rows one by one
            //  Iterator<Row> rowIterator = sheet.iterator();
            for (Row row : sheet) {
                for (int cn = 0; cn < row.getLastCellNum(); cn++) {

                    Cell cell = row.getCell(cn, Row.CREATE_NULL_AS_BLANK);
                    //System.out.println("CELL: " + cn + " --> " + cell.toString());
                    if(cn==3){
                    excelMarks=excelMarks+cell.toString()+",";
                    }
                }
            }
            file.close();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
        }
             System.out.println(">>>>>>>>>>>>>>>EXCEL MARKS>>>>>>>>>>>>>>>>>>>"+excelMarks);
             //*************************************************************************************************************************
            res.sendRedirect("/JIIT/EmployeeFiles/ExamActivity/ReconcileReport.jsp");
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}
